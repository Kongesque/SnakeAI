<!doctypehtml><html lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1"name=viewport><script src=https://cdn.tailwindcss.com></script><title>A Perfect Snake AI</title><body class="flex items-center justify-center bg-[#191a1a] h-screen max-w-xl mx-auto px-6 text-[#e8e8e6]"><div class="aspect-[16/9] bg-[#202222] border-[#3d3f40] border-[1px] rounded-lg w-full"id=snake-game-container><div class="flex items-center justify-center h-full"id=snake-game></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.2/p5.js></script><script>'use strict';let bx=40,by=20,mb=1E3,bs,xo=0,yo=0,s,ndm=!0,p=!1,spm=1,hc,ol=3,su_i=0; function setup(){su_i++;let a=select("#snake-game");bs=min(width/bx,height/by);createCanvas(a.width-bs,a.height-bs).parent("snake-game");pixelDensity(15);setBlocks();bs=min(width/bx,height/by);ol=bs/15;yo=xo=0;su_i==1&&setup();s=new Snake;hc=new HamiltonianCycle(bx,by);s.resetOnHamiltonian(hc.cycle);frameRate(30);a.mouseOver(()=>{spm=10;a.style("cursor","pointer")});a.mouseOut(()=>{spm=1;a.style("cursor","default")});window.addEventListener("resize",resize)} function setBlocks(){let a=1;for(;;)if(floor(canvas.width/a)*floor(canvas.height/a)<mb){bs=a;bx=floor(canvas.width/bs)-floor(canvas.width/bs)%2-2;by=floor(canvas.height/bs)-floor(canvas.height/bs)%2;break}else a++}function resize(){bs=min(width/bx,height/by);ol=bs/15;xo=(width-bs*bx)/2;yo=(height-bs*by)/2;setup()}var rd;function windowResized(){clearTimeout(rd);rd=setTimeout(resize,500)} function draw(){if(!p){background("#202222");stroke("#202222");strokeWeight(1);fill(20);rect(0,0,width,yo);rect(0,0,xo,height);rect(width,height,-width,-yo);rect(width,height,-xo,-height);push();translate(xo,yo);fill(0);s.show();for(let a=0;a<spm;a++)s.update();pop()}} class Snake{constructor(){this.x=floor(bx/2);this.y=floor(by/2);this.tb=[];this.tb.push(createVector(this.x-3,this.y));this.tb.push(createVector(this.x-2,this.y));this.tb.push(createVector(this.x-1,this.y));this.vx=1;this.vy=0;this.apple=new Apple(this);this.ac=0;this.sm=this.dead=!1;this.path;this.weWin=this.lg=this.nma=this.slpm=this.cbp=!1}resetOnHamiltonian(a){this.cycle=a;this.tb=[];this.tb.push(createVector(a[0].x,a[0].y));this.tb.push(createVector(a[1].x,a[1].y));this.tb.push(createVector(a[2].x, a[2].y));this.x=a[3].x;this.y=a[3].y;this.apple=new Apple(this);this.hcp=3;this.tcp=0}show(){noStroke();fill("#e8e8e6");ellipse(this.x*bs+bs/2,this.y*bs+bs/2,bs-ol*2,bs-ol*2);rect((this.x+this.tb[this.tb.length-1].x)*bs/2+ol,(this.y+this.tb[this.tb.length-1].y)*bs/2+ol,bs-ol*2,bs-ol*2);for(var a=0;a<this.tb.length;a++)ellipse(this.tb[a].x*bs+bs/2,this.tb[a].y*bs+bs/2,bs-ol*2,bs-ol*2),a<this.tb.length-1&&rect((this.tb[a].x+this.tb[a+1].x)/2*bs+ol,(this.tb[a].y+this.tb[a+1].y)/2*bs+ol,bs-ol*2,bs-ol* 2);this.weWin||this.apple.show()}move(){if(!this.weWin){if(!this.cbp)if((!this.path||this.path.pc>=this.path.pl)&&this.calcPath(),this.path&&this.path.pl!==0){var a=this.path.nextMove();this.vx=a.x;this.vy=a.y}else a=this.getNextPos(),this.vx=a.x-this.x,this.vy=a.y-this.y;this.ac<=0?(this.tb.splice(0,1),this.tcp=(this.tcp+1)%this.cycle.length):this.ac--;this.tb.push(createVector(this.x,this.y));this.x+=this.vx;this.y+=this.vy}}getNextPos(){this.apc=hc.getNodeNo(this.apple.x,this.apple.y);let a=hc.getPosFrom(this.x, this.y),b=1E5,c=0;for(let d=0;d<a.length;d++){let e=this.apc-a[d];for(;e<0;)e+=this.cycle.length;!this.overTakesTail(this.cycle[a[d]])&&e<b&&(b=e,c=d)}return b===1E5?this.cycle[(hc.getNodeNo(this.x,this.y)+1)%this.cycle.length]:this.cycle[a[c]]}overTakesTail(a,b,c){b=b?b.cn:hc.getNodeNo(this.x,this.y);c=c?hc.getNodeNo(c.x,c.y):hc.getNodeNo(this.tb[0].x,this.tb[0].y);if(this.getDist(b,c)<=50+this.ac)return!0;c=c-50-this.ac;c<0&&(c+=this.cycle.length);return this.getDist(b,a.cn)>=this.getDist(b,c)? !0:!1}getPathBasedOnAStar(){for(var a of this.cycle)a.resetAStar();this.apc=hc.getNodeNo(this.apple.x,this.apple.y);var b=this.cycle[hc.getNodeNo(this.x,this.y)];a=[];let c;b=new HPath(b,this.cycle[this.apc]);for(a.push(b);;){if(a.length===0)return c;b=a.shift();if(c&&b.pl>=c.pl)continue;if(b.dta===0){if(c==null||b.pl<c.pl)c=b.clone();continue}let e=b.getLastNode();if(!e.av||b.pl<e.sdp){e.av=!0;e.sdp=b.pl;for(var d of e.edges){if(this.overTakesTail(d,e,b.getSnakeTailPosAfterFollowingPath(this))&& d.cn!==e.cn+1)continue;let f=b.clone();f.addToTail(d);f.getLastNode().av&&f.pl>f.getLastNode().sdp||a.push(f)}}a.sort((f,n)=>f.dta+f.pl-(n.dta+n.pl))}}getDist(a,b){for(a=b-a;a<0;)a+=this.cycle.length;return a}checkFuturePos(){this.x+=this.vx;this.y+=this.vy;for(var a=0;a<this.tb.length;a++)this.tb[a].x===this.x&&this.tb[a].y===this.y&&(this.dead=!0);if(this.x<0||this.x>=bx||this.y<0||this.y>=by)this.dead=!0;this.x-=this.vx;this.y-=this.vy;this.dead&&(this.dead=!1,p=!0)}update(){this.dead||(this.move(), this.checkCollisions())}checkCollisions(){if(bx*by-(this.tb.length+1)<=0)this.weWin=!0,setup();else{for(var a=0;a<this.tb.length;a++)if(this.tb[a].x===this.x&&this.tb[a].y===this.y){this.dead=!0;return}this.x<0||this.x>=bx||this.y<0||this.y>=by?this.dead=!0:this.x===this.apple.x&&this.y===this.apple.y&&this.eatApple()}}eatApple(){this.ac+=4;this.apple=new Apple(this);this.calcPath()}calcPath(){this.path=this.getPathBasedOnAStar()}isAppleOnSnake(a){return this.snakeAtPos(a.x,a.y)}snakeAtPos(a,b){return this.snakeTailAtPos(a, b)||this.x==a&&this.y==b}snakeTailAtPos(a,b){for(var c=0;c<this.tb.length;c++)if(this.tb[c].x==a&&this.tb[c].y==b)return!0;return!1}}class Apple{constructor(a){this.x=floor(random(bx));for(this.y=floor(random(by));a.isAppleOnSnake(this);)this.x=floor(random(bx)),this.y=floor(random(by));print(a,this)}show(){noStroke();fill("#21b8cd");push();translate(this.x*bs+ol,this.y*bs+ol);ellipse(bs/2,bs/2,bs-2*ol,bs-2*ol);pop()}isAtPos(a,b){return this.x===a&&this.y===b}} class HamiltonianCycle{constructor(a,b){this.w=a;this.h=b;this.createCycle()}createCycle(){this.createST();var a=[];let b=[];for(a=0;a<this.w;a++)for(var c=0;c<this.h;c++)b.push(new HNode(a,c));for(var d of b)d.setEdges(b);for(a=0;a<this.stn.length;a++){d=this.stn[a];for(var e of d.san){c=(q,u,r,v)=>{u+this.h*q>=b.length||v+this.h*r>=b.length||(q=b[u+this.h*q],r=b[v+this.h*r],q.san.push(r),r.san.push(q))};let k=d.getDirTo(e),l=d.x*2,m=d.y*2;k.x===1?(c(l+1,m,l+2,m),c(l+1,m+1,l+2,m+1)):k.y===1&&(c(l, m+1,l,m+2),c(l+1,m+1,l+1,m+2))}}a=b.filter(k=>k.san.length===1);e=[];for(var f of a){a=f.san[0].getDirTo(f);a.x+=f.x;a.y+=f.y;a=new HEdge(b[a.y+this.h*a.x],f);d=!0;for(var n of e)if(n.isEqualTo(a)){d=!1;break}d&&e.push(a)}for(let k of e)k.connectNodes();a=b.filter(k=>k.san.length===1);e=[];for(var g of a)for(var h of a)if(dist(g.x,g.y,h.x,h.y)===1&&floor(g.x/2)===floor(h.x/2)&&floor(g.y/2)===floor(h.y/2)){f=new HEdge(h,g);n=!0;for(var t of e)if(t.isEqualTo(f)){n=!1;break}n&&e.push(f);break}for(let k of e)k.connectNodes(); a=[b.getRandom()];g=a[0];for(h=a[0].san[0];h!==a[0];)t=h.san[0],t===g&&(t=h.san[1]),a.push(h),g=h,h=t;this.cycle=a;for(g=0;g<this.cycle.length;g++)this.cycle[g].cn=g}show(){for(let a=0;a<this.cycle.length;a++)push(),translate(bs/2,bs/2),scale(bs),fill(255),textAlign(CENTER,CENTER),textSize(.3),text(a,this.cycle[a].x,this.cycle[a].y),stroke(255,100),strokeWeight(.1),a!==this.cycle.length-1?line(this.cycle[a].x,this.cycle[a].y,this.cycle[a+1].x,this.cycle[a+1].y):line(this.cycle[a].x,this.cycle[a].y, this.cycle[0].x,this.cycle[0].y),pop()}createST(){let a=[];for(var b=0;b<this.w/2;b++)for(var c=0;c<this.h/2;c++)a.push(new HNode(b,c));for(var d of a)d.setEdges(a);b=[];c=a[floor(random(a.length))];b.push(new HEdge(c,c.edges[0]));let e=[c,c.edges[0]];for(;e.length<a.length;)c=e.getRandom(),d=c.edges.filter(f=>!e.includes(f)),d.length!==0&&(d=d.getRandom(),e.push(d),b.push(new HEdge(c,d)));for(let f of a)f.setStEdges(b);this.st=b;this.stn=a}getNextPos(a,b){for(let c=0;c<this.cycle.length;c++)if(this.cycle[c].x=== a&&this.cycle[c].y===b)return this.cycle[(c+1)%this.cycle.length];return null}getNodeNo(a,b){for(let c=0;c<this.cycle.length;c++)if(this.cycle[c].x===a&&this.cycle[c].y===b)return c;return-1}getPosFrom(a,b){a=this.cycle[this.getNodeNo(a,b)];b=[];for(let c of a.edges)b.push(this.getNodeNo(c.x,c.y));return b}}Array.prototype.getRandom=function(){return this[floor(random(this.length))]}; class HNode{constructor(a,b){this.x=a;this.y=b;this.san=[];this.cn=-1;this.av=!1;this.sdp=0}setEdges(a){this.edges=a.filter(b=>dist(b.x,b.y,this.x,this.y)===1)}setStEdges(a){for(let b of a)b.contains(this)&&this.san.push(b.getOtherNode(this))}getNextNodeMovingLeft(a){let b=a.getDirTo(this);a=[];for(var c of this.san)a.push(this.getDirTo(c));for(c=getLeftOf(b);!a.includes(c);)c=getRightOf(c);return this.san[a.indexOf(c)]}getDirTo(a){return{x:a.x-this.x,y:a.y-this.y}}resetAStar(){this.av=!1;this.sdp= 0}}function getLeftOf(a){return a.x===0&&a.y===1?{x:1,y:0}:a.x===0&&a.y===-1?{x:-1,y:0}:a.x===1?{x:0,y:-1}:{x:0,y:1}}function getRightOf(a){return a.x===0&&a.y===1?{x:-1,y:0}:a.x===0&&a.y===-1?{x:1,y:0}:a.x===1?{x:0,y:1}:{x:0,y:-1}} class HEdge{constructor(a,b){this.n1=a;this.n2=b}isEqualTo(a){return this.n1===a.n1&&this.n2===a.n2||this.n1===a.n2&&this.n2===a.n1}contains(a){return a===this.n1||a===this.n2}getOtherNode(a){return a===this.n1?this.n2:this.n1}connectNodes(){this.n1.san.push(this.n2);this.n2.san.push(this.n1)}} class HPath{constructor(a,b){this.pl=0;this.nodes=[a];this.finishNode=b;this.dta=0;this.setDta();this.pc=0}setDta(){this.dta=dist(this.finishNode.x,this.finishNode.y,this.getLastNode().x,this.getLastNode().y)}addToTail(a){this.nodes.push(a);this.pl+=1;this.setDta()}getLastNode(){return this.nodes[this.nodes.length-1]}getSnakeTailPosAfterFollowingPath(a){return this.pl-a.ac<a.tb.length?a.tb[Math.max(0,this.pl-a.ac)]:this.nodes[this.pl-a.ac-a.tb.length]}nextMove(){let a=this.nodes[this.pc+1].x-this.nodes[this.pc].x, b=this.nodes[this.pc+1].y-this.nodes[this.pc].y;this.pc++;return{x:a,y:b}}clone(){let a=new HPath(this.nodes[0],this.finishNode);a.nodes=[...this.nodes];a.pl=this.pl;a.dta=this.dta;return a}};</script>