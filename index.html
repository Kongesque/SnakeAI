<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>A Perfect Snake AI</title>
    
</head>
<body class="flex items-center justify-center h-screen mx-auto max-w-xl px-6 bg-[#191a1a] text-[#e8e8e6]">  
    <div class="w-full aspect-[16/9] bg-[#202222] rounded-lg border-[1px] border-[#3d3f40]" id="snake-game-container">
        <div class="flex justify-center items-center h-full" id="snake-game"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.2/p5.js"></script>
    <script>
        'use strict';var blocksX=40,blocksY=20;let maxBlocks=1E3,blockSize,xOffset=0,yOffset=0,s,noDieMode=!0,pause=!1,speedMultiplier=1,hc,outlineLength=3,setup_i=0;
        function setup(){setup_i++;let a=select("#snake-game");blockSize=min(width/blocksX,height/blocksY);createCanvas(a.width-blockSize,a.height-blockSize).parent("snake-game");pixelDensity(15);setBlocks();blockSize=min(width/blocksX,height/blocksY);outlineLength=blockSize/15;yOffset=xOffset=0;setup_i==1&&setup();s=new Snake;hc=new HamiltonianCycle(blocksX,blocksY);s.resetOnHamiltonian(hc.cycle);frameRate(30);a.mouseOver(()=>{speedMultiplier=10;a.style("cursor","pointer")});a.mouseOut(()=>{speedMultiplier=
        1;a.style("cursor","default")});window.addEventListener("resize",resize)}function setBlocks(){let a=1;for(;;)if(floor(canvas.width/a)*floor(canvas.height/a)<maxBlocks){blockSize=a;blocksX=floor(canvas.width/blockSize)-floor(canvas.width/blockSize)%2-2;blocksY=floor(canvas.height/blockSize)-floor(canvas.height/blockSize)%2;break}else a++}
        function resize(){blockSize=min(width/blocksX,height/blocksY);outlineLength=blockSize/15;xOffset=(width-blockSize*blocksX)/2;yOffset=(height-blockSize*blocksY)/2;setup()}var resizeDelay;function windowResized(){clearTimeout(resizeDelay);resizeDelay=setTimeout(resize,500)}
        function draw(){if(!pause){background("#202222");stroke("#202222");strokeWeight(1);fill(20);rect(0,0,width,yOffset);rect(0,0,xOffset,height);rect(width,height,-width,-yOffset);rect(width,height,-xOffset,-height);push();translate(xOffset,yOffset);fill(0);s.show();for(let a=0;a<speedMultiplier;a++)s.update();pop()}}
        class Snake{constructor(){this.x=floor(blocksX/2);this.y=floor(blocksY/2);this.tailBlocks=[];this.tailBlocks.push(createVector(this.x-3,this.y));this.tailBlocks.push(createVector(this.x-2,this.y));this.tailBlocks.push(createVector(this.x-1,this.y));this.velX=1;this.velY=0;this.apple=new Apple(this);this.addCount=0;this.survivalMode=this.dead=!1;this.path;this.weWin=this.lateGame=this.noMoreAStar=this.searchForLongestPathModeActive=this.controlledByPlayer=!1}resetOnHamiltonian(a){this.cycle=a;this.tailBlocks=
        [];this.tailBlocks.push(createVector(a[0].x,a[0].y));this.tailBlocks.push(createVector(a[1].x,a[1].y));this.tailBlocks.push(createVector(a[2].x,a[2].y));this.x=a[3].x;this.y=a[3].y;this.apple=new Apple(this);this.headCyclePosition=3;this.tailCyclePosition=0}show(){noStroke();fill("#e8e8e6");ellipse(this.x*blockSize+blockSize/2,this.y*blockSize+blockSize/2,blockSize-outlineLength*2,blockSize-outlineLength*2);rect((this.x+this.tailBlocks[this.tailBlocks.length-1].x)*blockSize/2+outlineLength,(this.y+
        this.tailBlocks[this.tailBlocks.length-1].y)*blockSize/2+outlineLength,blockSize-outlineLength*2,blockSize-outlineLength*2);for(var a=0;a<this.tailBlocks.length;a++)ellipse(this.tailBlocks[a].x*blockSize+blockSize/2,this.tailBlocks[a].y*blockSize+blockSize/2,blockSize-outlineLength*2,blockSize-outlineLength*2),a<this.tailBlocks.length-1&&rect((this.tailBlocks[a].x+this.tailBlocks[a+1].x)/2*blockSize+outlineLength,(this.tailBlocks[a].y+this.tailBlocks[a+1].y)/2*blockSize+outlineLength,blockSize-outlineLength*
        2,blockSize-outlineLength*2);this.weWin||this.apple.show()}move(){if(!this.weWin){if(!this.controlledByPlayer)if((!this.path||this.path.pathCounter>=this.path.pathLength)&&this.calculatePath(),this.path&&this.path.pathLength!==0){var a=this.path.getNextMove();this.velX=a.x;this.velY=a.y}else a=this.getNextPosition(),this.velX=a.x-this.x,this.velY=a.y-this.y;this.addCount<=0?(this.tailBlocks.splice(0,1),this.tailCyclePosition=(this.tailCyclePosition+1)%this.cycle.length):this.addCount--;this.tailBlocks.push(createVector(this.x,
        this.y));this.x+=this.velX;this.y+=this.velY}}getNextPosition(){this.appleCyclePosition=hc.getNodeNo(this.apple.x,this.apple.y);let a=hc.getPossiblePositionsFrom(this.x,this.y),b=1E5,c=0;for(let d=0;d<a.length;d++){let e=this.appleCyclePosition-a[d];for(;e<0;)e+=this.cycle.length;!this.overTakesTail(this.cycle[a[d]])&&e<b&&(b=e,c=d)}return b===1E5?this.cycle[(hc.getNodeNo(this.x,this.y)+1)%this.cycle.length]:this.cycle[a[c]]}overTakesTail(a,b,c){b=b?b.cycleNo:hc.getNodeNo(this.x,this.y);c=c?hc.getNodeNo(c.x,
        c.y):hc.getNodeNo(this.tailBlocks[0].x,this.tailBlocks[0].y);if(this.getDistanceBetweenPoints(b,c)<=50+this.addCount)return!0;c=c-50-this.addCount;c<0&&(c+=this.cycle.length);return this.getDistanceBetweenPoints(b,a.cycleNo)>=this.getDistanceBetweenPoints(b,c)?!0:!1}getPathBasedOnAStar(){for(var a of this.cycle)a.resetForAStar();this.appleCyclePosition=hc.getNodeNo(this.apple.x,this.apple.y);var b=this.cycle[hc.getNodeNo(this.x,this.y)];a=[];let c;b=new HPath(b,this.cycle[this.appleCyclePosition]);
        for(a.push(b);;){if(a.length===0)return c;b=a.shift();if(c&&b.pathLength>=c.pathLength)continue;if(b.distanceToApple===0){if(c==null||b.pathLength<c.pathLength)c=b.clone();continue}let e=b.getLastNode();if(!e.alreadyVisited||b.pathLength<e.shortestDistanceToThisPoint){e.alreadyVisited=!0;e.shortestDistanceToThisPoint=b.pathLength;for(var d of e.edges){if(this.overTakesTail(d,e,b.getSnakeTailPositionAfterFollowingPath(this))&&d.cycleNo!==e.cycleNo+1)continue;let f=b.clone();f.addToTail(d);f.getLastNode().alreadyVisited&&
        f.pathLength>f.getLastNode().shortestDistanceToThisPoint||a.push(f)}}a.sort((f,n)=>f.distanceToApple+f.pathLength-(n.distanceToApple+n.pathLength))}}getDistanceBetweenPoints(a,b){for(a=b-a;a<0;)a+=this.cycle.length;return a}checkFuturePos(){this.x+=this.velX;this.y+=this.velY;for(var a=0;a<this.tailBlocks.length;a++)this.tailBlocks[a].x===this.x&&this.tailBlocks[a].y===this.y&&(this.dead=!0);if(this.x<0||this.x>=blocksX||this.y<0||this.y>=blocksY)this.dead=!0;this.x-=this.velX;this.y-=this.velY;this.dead&&
        (this.dead=!1,pause=!0)}update(){this.dead||(this.move(),this.checkCollisions())}checkCollisions(){if(blocksX*blocksY-(this.tailBlocks.length+1)<=0)this.weWin=!0,setup();else{for(var a=0;a<this.tailBlocks.length;a++)if(this.tailBlocks[a].x===this.x&&this.tailBlocks[a].y===this.y){this.dead=!0;return}this.x<0||this.x>=blocksX||this.y<0||this.y>=blocksY?this.dead=!0:this.x===this.apple.x&&this.y===this.apple.y&&this.ateApple()}}ateApple(){this.addCount+=4;this.apple=new Apple(this);this.calculatePath()}calculatePath(){this.path=
        this.getPathBasedOnAStar()}isAppleOnSnake(a){return this.snakeAtPosition(a.x,a.y)}snakeAtPosition(a,b){return this.snakeTailAtPosition(a,b)||this.x==a&&this.y==b}snakeTailAtPosition(a,b){for(var c=0;c<this.tailBlocks.length;c++)if(this.tailBlocks[c].x==a&&this.tailBlocks[c].y==b)return!0;return!1}}
        class Apple{constructor(a){this.x=floor(random(blocksX));for(this.y=floor(random(blocksY));a.isAppleOnSnake(this);)this.x=floor(random(blocksX)),this.y=floor(random(blocksY));print(a,this)}show(){noStroke();fill("#21b8cd");push();translate(this.x*blockSize+outlineLength,this.y*blockSize+outlineLength);ellipse(blockSize/2,blockSize/2,blockSize-2*outlineLength,blockSize-2*outlineLength);pop()}isAtPosition(a,b){return this.x===a&&this.y===b}}
        class HamiltonianCycle{constructor(a,b){this.w=a;this.h=b;this.createCycle()}createCycle(){this.createSpanningTree();var a=[];let b=[];for(a=0;a<this.w;a++)for(var c=0;c<this.h;c++)b.push(new HNode(a,c));for(var d of b)d.setEdges(b);for(a=0;a<this.spanningTreeNodes.length;a++){d=this.spanningTreeNodes[a];for(var e of d.spanningTreeAdjacentNodes){c=(p,t,q,u)=>{t+this.h*p>=b.length||u+this.h*q>=b.length||(p=b[t+this.h*p],q=b[u+this.h*q],p.spanningTreeAdjacentNodes.push(q),q.spanningTreeAdjacentNodes.push(p))};
        let k=d.getDirectionTo(e),l=d.x*2,m=d.y*2;k.x===1?(c(l+1,m,l+2,m),c(l+1,m+1,l+2,m+1)):k.y===1&&(c(l,m+1,l,m+2),c(l+1,m+1,l+1,m+2))}}a=b.filter(k=>k.spanningTreeAdjacentNodes.length===1);e=[];for(var f of a){a=f.spanningTreeAdjacentNodes[0].getDirectionTo(f);a.x+=f.x;a.y+=f.y;a=new HEdge(b[a.y+this.h*a.x],f);d=!0;for(var n of e)if(n.isEqualTo(a)){d=!1;break}d&&e.push(a)}for(let k of e)k.connectNodes();a=b.filter(k=>k.spanningTreeAdjacentNodes.length===1);e=[];for(var g of a)for(var h of a)if(dist(g.x,
        g.y,h.x,h.y)===1&&floor(g.x/2)===floor(h.x/2)&&floor(g.y/2)===floor(h.y/2)){f=new HEdge(h,g);n=!0;for(var r of e)if(r.isEqualTo(f)){n=!1;break}n&&e.push(f);break}for(let k of e)k.connectNodes();a=[b.getRandomElement()];g=a[0];for(h=a[0].spanningTreeAdjacentNodes[0];h!==a[0];)r=h.spanningTreeAdjacentNodes[0],r===g&&(r=h.spanningTreeAdjacentNodes[1]),a.push(h),g=h,h=r;this.cycle=a;for(g=0;g<this.cycle.length;g++)this.cycle[g].cycleNo=g}show(){for(let a=0;a<this.cycle.length;a++)push(),translate(blockSize/
        2,blockSize/2),scale(blockSize),fill(255),textAlign(CENTER,CENTER),textSize(.3),text(a,this.cycle[a].x,this.cycle[a].y),stroke(255,100),strokeWeight(.1),a!==this.cycle.length-1?line(this.cycle[a].x,this.cycle[a].y,this.cycle[a+1].x,this.cycle[a+1].y):line(this.cycle[a].x,this.cycle[a].y,this.cycle[0].x,this.cycle[0].y),pop()}createSpanningTree(){let a=[];for(var b=0;b<this.w/2;b++)for(var c=0;c<this.h/2;c++)a.push(new HNode(b,c));for(var d of a)d.setEdges(a);b=[];c=a[floor(random(a.length))];b.push(new HEdge(c,
        c.edges[0]));let e=[c,c.edges[0]];for(;e.length<a.length;)c=e.getRandomElement(),d=c.edges.filter(f=>!e.includes(f)),d.length!==0&&(d=d.getRandomElement(),e.push(d),b.push(new HEdge(c,d)));for(let f of a)f.setSpanningTreeEdges(b);this.spanningTree=b;this.spanningTreeNodes=a}getNextPosition(a,b){for(let c=0;c<this.cycle.length;c++)if(this.cycle[c].x===a&&this.cycle[c].y===b)return this.cycle[(c+1)%this.cycle.length];return null}getNodeNo(a,b){for(let c=0;c<this.cycle.length;c++)if(this.cycle[c].x===
        a&&this.cycle[c].y===b)return c;return-1}getPossiblePositionsFrom(a,b){a=this.cycle[this.getNodeNo(a,b)];b=[];for(let c of a.edges)b.push(this.getNodeNo(c.x,c.y));return b}}Array.prototype.getRandomElement=function(){return this[floor(random(this.length))]};
        class HNode{constructor(a,b){this.x=a;this.y=b;this.spanningTreeAdjacentNodes=[];this.cycleNo=-1;this.alreadyVisited=!1;this.shortestDistanceToThisPoint=0}setEdges(a){this.edges=a.filter(b=>dist(b.x,b.y,this.x,this.y)===1)}setSpanningTreeEdges(a){for(let b of a)b.contains(this)&&this.spanningTreeAdjacentNodes.push(b.getOtherNode(this))}getNextNodeMovingLeft(a){let b=a.getDirectionTo(this);a=[];for(var c of this.spanningTreeAdjacentNodes)a.push(this.getDirectionTo(c));for(c=getLeftOf(b);!a.includes(c);)c=
        getRightOf(c);return this.spanningTreeAdjacentNodes[a.indexOf(c)]}getDirectionTo(a){return{x:a.x-this.x,y:a.y-this.y}}resetForAStar(){this.alreadyVisited=!1;this.shortestDistanceToThisPoint=0}}function getLeftOf(a){return a.x===0&&a.y===1?{x:1,y:0}:a.x===0&&a.y===-1?{x:-1,y:0}:a.x===1?{x:0,y:-1}:{x:0,y:1}}function getRightOf(a){return a.x===0&&a.y===1?{x:-1,y:0}:a.x===0&&a.y===-1?{x:1,y:0}:a.x===1?{x:0,y:1}:{x:0,y:-1}}
        class HEdge{constructor(a,b){this.node1=a;this.node2=b}isEqualTo(a){return this.node1===a.node1&&this.node2===a.node2||this.node1===a.node2&&this.node2===a.node1}contains(a){return a===this.node1||a===this.node2}getOtherNode(a){return a===this.node1?this.node2:this.node1}connectNodes(){this.node1.spanningTreeAdjacentNodes.push(this.node2);this.node2.spanningTreeAdjacentNodes.push(this.node1)}}
        class HPath{constructor(a,b){this.pathLength=0;this.nodesInPath=[a];this.finishNode=b;this.distanceToApple=0;this.setDistanceToApple();this.pathCounter=0}setDistanceToApple(){this.distanceToApple=dist(this.finishNode.x,this.finishNode.y,this.getLastNode().x,this.getLastNode().y)}addToTail(a){this.nodesInPath.push(a);this.pathLength+=1;this.setDistanceToApple()}getLastNode(){return this.nodesInPath[this.nodesInPath.length-1]}getSnakeTailPositionAfterFollowingPath(a){return this.pathLength-a.addCount<
        a.tailBlocks.length?a.tailBlocks[Math.max(0,this.pathLength-a.addCount)]:this.nodesInPath[this.pathLength-a.addCount-a.tailBlocks.length]}getNextMove(){let a=this.nodesInPath[this.pathCounter+1].x-this.nodesInPath[this.pathCounter].x,b=this.nodesInPath[this.pathCounter+1].y-this.nodesInPath[this.pathCounter].y;this.pathCounter++;return{x:a,y:b}}clone(){let a=new HPath(this.nodesInPath[0],this.finishNode);a.nodesInPath=[...this.nodesInPath];a.pathLength=this.pathLength;a.distanceToApple=this.distanceToApple;
        return a}};
    </script>
</body>
</html>
